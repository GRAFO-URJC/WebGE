<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}"
      lang="en">
<head>
    <!-- For the profile template -->
    <link th:href="@{/assets/dist/css/experimentRepository.css}" rel="stylesheet" id="experimentRepository-css"/>

    <style>
        /* enable absolute positioning */
        .inner-addon {
            position: relative;
        }

        /* style icon */
        .inner-addon .glyphicon {
            position: absolute;
            padding: 5px;
            pointer-events: none;
        }

        /* align icon */
        .left-addon .glyphicon {
            left: 0px;
        }

        .right-addon .glyphicon {
            right: 0px;
        }

        /* add padding  */
        .left-addon input {
            padding-left: 30px;
        }

        .right-addon input {
            padding-right: 30px;
        }
    </style>

    <title>Experiment list by User</title>
</head>
<body>
<div id="page" layout:fragment="content" message=${errorMessage}>
    <!-- Main -->
    <div class="container">
        <div class="row">
            <div id="forms" class="panel panel-default">
                <header class="panel-heading">
                    <h2>List of experiments User: <span th:text="${user.username}"></span></h2>
                </header>

                <section class="panel-body center-block">
                    <div th:if="${not #lists.isEmpty(experimentList)}">
                        <div class="inner-addon left-addon">
                            <i class="glyphicon glyphicon-search "></i>
                            <input class="form-control" id="searchExperiment" type="text"
                                   placeholder="Search experiment ..."/>
                        </div>
                        <br/>
                        <table class="table table-hover display" id="expRepository">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Experiment name</th>
                                <th scope="col">Experiment description</th>
                                <th scope="col">Creation date</th>
                                <th scope="col">Controls</th>
                                <th scope="col"></th>
                                <th scope="col" style="display:none;">Experiment information</th>
                            </tr>
                            </thead>
                            <tbody id="expTableBody">
                            <th:block th:each="exp, iterStat : ${experimentList}">
                                <tr th:id="'tr' + ${iterStat.index}">
                                    <td scope="row"><label th:name="id" th:id="id" th:text="${exp.id}" id="id"/>
                                    </td>
                                    <td scope="row"><label th:name="name" th:id="name"
                                                           th:text="${exp.experimentName}" id="name"/></td>
                                    <td scope="row"><label th:name="description" th:id="description"
                                                           th:text="${exp.experimentDescription}" id="description"/>
                                    </td>
                                    <td scope="row"><label th:name="creationDate" th:id="creationDate"
                                                           th:text="${exp.getCreationDate()}" id="creationDate"/>
                                    </td>
                                    <td scope="row" class="details-control">
                                        <button type="button">More information</button>
                                    </td>
                                    <td scope="row">
                                        <form th:action="@{/experiment/expRepoSelected}" th:object="${expRepository}"
                                              method="GET">
                                            <input type="text" class="hiddenInput" th:name="id"
                                                   th:value="${exp.getId()}"/>
                                            <button type="submit"
                                                    th:name="loadExperimentButton" class="btn-default btn btn-sm">Load
                                                experiment
                                            </button>
                                            <button type="button" th:name="${exp.id}"
                                                    th:id="${'deleteExperiment' + iterStat.index}"
                                                    onclick="confirmDelete(this.id, this.name)"
                                                    class="btn-default btn btn-sm"
                                                    rel="tooltip"
                                                    title="Delete experiment"
                                            ><span class="glyphicon glyphicon-trash small"></span></button>
                                        </form>
                                    </td>
                                    <!--with extra information-->
                                    <td scope="control" style="display:none;">

                                        <p>
                                            <span class="glyphicon glyphicon-chevron-right"> The experiment has
                                            <label th:text="${exp.getIdExpDataTypeList().size()}"></label>
                                                <i>data type file/s</i>
                                            </span>
                                        </p>
                                        <p>
                                            <span class="glyphicon glyphicon-chevron-right"> The experiment has
                                            <label th:text="${exp.getIdGrammarList().size()}"></label>
                                                <i>grammar/s</i>
                                            </span>
                                        </p>
                                        <div th:if="${not #lists.isEmpty(exp.getIdRunList())}" th:with="expRunConfiguration=${exp.getIdRunList().get(exp.getIdRunList().size()-1)}">
                                            <p>
                                            <span class="glyphicon glyphicon-chevron-right"> Experiment last configuration in use:
                                            </p>
                                                <b>Generations:</b>
                                            <label th:text="${expRunConfiguration.getGenerations()}"></label>
                                                ;<b>Crossover Prob:</b>
                                            <label th:text="${expRunConfiguration.getCrossoverProb()}"></label>
                                                ;<b>Population Size:</b>
                                            <label th:text="${expRunConfiguration.getPopulationSize()}"></label>
                                                ;<b>Mutation Prob:</b>
                                            <label th:text="${expRunConfiguration.getMutationProb()}"></label>
                                                ;<b>Max Wraps:</b>
                                            <label th:text="${expRunConfiguration.getMaxWraps()}"></label>
                                                ;<b>Num Codons:</b>
                                            <label th:text="${expRunConfiguration.getNumCodons()}"></label>
                                                ;<b>Tournament:</b>
                                            <label th:text="${expRunConfiguration.getTournament()}"></label>
                                                ;<b>Number Runs:</b>
                                            <label th:text="${expRunConfiguration.getNumberRuns()}"></label>
                                                ;<b><b>Objective:</b>
                                            <label th:text="${expRunConfiguration.getObjective()}"></label>
                                            </span>

                                        </div>
                                        <p>
                                            <span class="glyphicon glyphicon-chevron-right"> The experiment has
                                            <label th:text="${exp.getIdRunList().size()}"></label>
                                                <i>runs</i>
                                            </span>
                                        </p>
                                        <div th:if="${not #lists.isEmpty(exp.getIdRunList())}">
                                            <table class="table table-hover">

                                                <thead>
                                                <tr>
                                                    <th scope="col"># Run</th>
                                                    <th scope="col">Run name</th>
                                                    <th scope="col">Best solution</th>
                                                    <th scope="col">Current generation</th>
                                                    <th scope="col">Status</th>
                                                    <th scope="col">Creation date</th>
                                                    <th scope="col">Last modification date</th>
                                                    <th scope="col">Model</th>
                                                </tr>
                                                </thead>
                                                <tbody>

                                                <th:block th:each="run, iterStat : ${exp.getIdRunList()}">
                                                    <tr th:id="'tr' + ${iterStat.index}">
                                                        <td scope="row"><label th:text="${run.getId()}"
                                                                               th:id="'runId'+${iterStat.index}"/></td>
                                                        <td scope="row"><label th:name="runName" th:id="runName"
                                                                               th:text="${run.getExperimentName()}"/>
                                                        </td>
                                                        <td scope="row"><label th:name="bestIndividual"
                                                                               th:id="'bestIndividual'+${iterStat.index}"
                                                                               th:text="${run.getDiagramData().bestIndividual}"/>
                                                        </td>
                                                        <td scope="row"><label th:name="currentGeneration"
                                                                               th:id="'currentGeneration'+${iterStat.index}"
                                                                               th:text="${run.getDiagramData().currentGeneration}"/>
                                                        </td>
                                                        <td scope="row"><label th:name="status"
                                                                               th:id="'status'+${iterStat.index}"
                                                                               th:text="${run.getStatus()}"/></td>
                                                        <td scope="row"><label th:name="iniDate" th:id="iniDate"
                                                                               th:text="${run.getIniDate()}"/></td>
                                                        <td scope="row"><label th:name="lastDate" th:id="lastDate"
                                                                               th:text="${run.getModificationDate()}"/>
                                                        </td>
                                                        <td scope="row"><label th:name="model"
                                                                               th:id="model+${iterStat.index}"
                                                                               th:text="${run.getModel()}"/></td>
                                                    </tr>
                                                </th:block>
                                                </tbody>
                                            </table>

                                        </div>
                                    </td>
                                </tr>

                            </th:block>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
        <!-- END Main -->


        <!-- Modal -->
        <div id="detailsModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Experiment details</h4>
                    </div>
                    <div class="modal-body">
                        <p>Details experiment.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- END Modal -->
    </div>


    <script>
        $("#expTypeTable tr").attr({"id": "selected"}).siblings().removeAttr('id');
        $("#moreDetails").attr("")
    </script>

    <script>
        $(document).ready(function () {
            $("#searchExperiment").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#expTableBody tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });

            tableDefinition('#expRepository', "#expTableBody", 4, 5, 6);

        });

        function confirmDelete(iterStat, expId) {
            var result = confirm("Are you sure to delete this experiment ?");
            if (result)
                deleteRow(iterStat, expId);
        }


        function deleteRow(iterStat, expId) {
            var cleanIterStat = iterStat.substring("deleteExperiment".length, iterStat.length);   // Dará error, si hay listado con mas de 9 obj, no pillará el id de 10, pq sólo mira hasta el último

            $.ajax({
                url: encodeURI("/experiment/expRepoSelected"),
                data: {
                    'experimentId': expId,
                    'deleteExperiment': 'deleteExperiment'
                },
                cache: false,
                async: true,
                type: "POST",
                dataType: "json",
                success: function (data) {
                    $("#tr" + cleanIterStat).remove();
                    $("#trAux" + cleanIterStat).remove();
                }
            });
        };

    </script>
</div>
</body>
</html>