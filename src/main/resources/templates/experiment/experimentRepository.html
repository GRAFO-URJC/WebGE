<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}"
      lang="en">
<head>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"/>
    <!-- For the profile template -->
    <link th:href="@{/assets/dist/css/experimentRepository.css}" rel="stylesheet" id="experimentRepository-css"/>

    <style>
        /* enable absolute positioning */
        .inner-addon {
            position: relative;
        }

        /* style icon */
        .inner-addon .glyphicon {
            position: absolute;
            padding: 5px;
            pointer-events: none;
        }

        /* align icon */
        .left-addon .glyphicon {
            left: 0px;
        }

        .right-addon .glyphicon {
            right: 0px;
        }

        /* add padding  */
        .left-addon input {
            padding-left: 30px;
        }

        .right-addon input {
            padding-right: 30px;
        }
    </style>

    <title>Experiment list by User</title>
</head>
<body>
<div id="page" layout:fragment="content" message=${errorMessage}>
    <!-- Main -->
    <div class="container">
        <div class="row">
            <div id="forms" class="panel panel-default">
                <header class="panel-heading">
                    <h2>List of experiments User: <span th:text="${user.username}"></span></h2>
                </header>

                <section class="panel-body center-block">
                    <div th:if="${not #lists.isEmpty(experimentList)}">
                        <div class="inner-addon left-addon">
                            <i class="glyphicon glyphicon-search "></i>
                            <input class="form-control" id="searchExperiment" type="text"
                                   placeholder="Search experiment ..."/>
                        </div>
                        <br/>
                        <table class="table table-hover display" id="expRepository">
                            <thead>
                            <tr>
                                <th scope="col">#</th>
                                <th scope="col">Experiment name</th>
                                <th scope="col">Experiment description</th>
                                <th scope="col">Creation date</th>
                                <th scope="col">Controls</th>
                                <th scope="col"></th>
                                <th scope="col" style="display:none;">Experiment information</th>
                            </tr>
                            </thead>
                            <tbody id="expTable">
                            <th:block th:each="exp, iterStat : ${experimentList}">
                                <tr th:id="'tr' + ${iterStat.index}">
                                    <td scope="row"><label th:name="id" th:id="id" th:text="${exp.id}" id="id"/>
                                    </td>
                                    <td scope="row"><label th:name="name" th:id="name"
                                                           th:text="${exp.experimentName}" id="name"/></td>
                                    <td scope="row"><label th:name="description" th:id="description"
                                                           th:text="${exp.experimentDescription}" id="description"/>
                                    </td>
                                    <td scope="row"><label th:name="creationDate" th:id="creationDate"
                                                           th:text="${exp.getCreationDate()}" id="creationDate"/>
                                    </td>
                                    <td scope="row" class="details-control">
                                        <button type="button">More information</button>
                                    </td>
                                    <td scope="row">
                                        <form th:action="@{/experiment/expRepoSelected}" th:object="${expRepository}"
                                              method="GET">
                                            <input type="text" class="hiddenInput" th:name="id" th:id="id"
                                                   th:value="${exp.getId()}"/>
                                            <button type="submit" th:id="loadExperimentButton"
                                                    th:name="loadExperimentButton" class="btn-default btn btn-sm">Load
                                                experiment
                                            </button>
                                            <button type="button" th:name="${exp.id}"
                                                    th:id="${'deleteExperiment' + iterStat.index}"
                                                    onclick="confirmDelete(this.id, this.name)"
                                                    class="btn-default btn btn-sm"
                                                    rel="tooltip"
                                                    title="Delete experiment"
                                            ><span class="glyphicon glyphicon-trash small"></span></button>
                                        </form>
                                    </td>
                                    <!--with extra information-->
                                    <td scope="control" style="display:none;">

                                        <p>
                                            <span class="glyphicon glyphicon-chevron-right"> The experiment has
                                            <label th:text="${exp.getIdRunList().size()}"></label>
                                                <i>runs</i>
                                            </span>
                                        </p>

                                        <p>
                                            <span class="glyphicon glyphicon-chevron-right"> The experiment has
                                            <label th:text="${exp.getIdExpDataTypeList().size()}"></label>
                                                <i>data type file/s</i>
                                            </span>
                                        </p>

                                    </td>
                                </tr>

                            </th:block>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
        <!-- END Main -->


        <!-- Modal -->
        <div id="detailsModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Experiment details</h4>
                    </div>
                    <div class="modal-body">
                        <p>Details experiment.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- END Modal -->
    </div>


    <script>
        $("#expTypeTable tr").attr({"id": "selected"}).siblings().removeAttr('id');
        $("#moreDetails").attr("")
    </script>

    <script>
        let table;
        $(document).ready(function () {
            $("#searchExperiment").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $("#expTable tr").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
            //table pagination
            table =$('#expRepository').DataTable({
                "paging": true,
                "searching": false,
                "columnDefs": [ {
                    "targets": [4,5],
                    "orderable": false
                } ]
            });
            $('.dataTables_length').addClass('bs-select');

        });

        function format(d) {
            // `d` is the original data object for the row
            return '<div class="slider" style="display: none;">'+
                d[6] +
                '</div>';
        }

        $('#expRepository tbody').on('click', 'td.details-control', function () {
            let tr = $(this).closest('tr');
            let row = table.row(tr);

            if (row.child.isShown()) {
                // This row is already open - close it
                $('div.slider', row.child()).slideUp(function () {
                    row.child.hide();
                    //tr.removeClass('shown');
                });
            } else {
                // Open this row
                row.child(format(row.data())).show();
                tr.addClass('shown');
                $('div.slider', row.child()).slideDown();
            }
        });

        function confirmDelete(iterStat, expId) {
            var result = confirm("Are you sure to delete this experiment ?");
            if (result)
                deleteRow(iterStat, expId);
        }


        function deleteRow(iterStat, expId) {
            var cleanIterStat = iterStat.substring("deleteExperiment".length, iterStat.length);   // Dará error, si hay listado con mas de 9 obj, no pillará el id de 10, pq sólo mira hasta el último

            $.ajax({
                url: encodeURI("/experiment/expRepoSelected"),
                data: {
                    'experimentId': expId,
                    'deleteExperiment': 'deleteExperiment'
                },
                cache: false,
                async: true,
                type: "POST",
                dataType: "json",
                success: function (data) {
                    $("#tr" + cleanIterStat).remove();
                    $("#trAux" + cleanIterStat).remove();
                }
            });
        };

    </script>
</div>
</body>
</html>