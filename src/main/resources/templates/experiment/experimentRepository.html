<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}"
      lang="en">
<head>


    <title>WebGE - Experiment list by User</title>
</head>
<body>
<div id="page" layout:fragment="content" message=${errorMessage}>
    <!-- Main -->
    <div class="container">
        <div class="row">
            <div id="forms" class="panel panel-default">
                <header class="panel-heading">
                    <div class="row">
                        <div class="col-sm-9">
                            <h2>List of experiments</h2>
                        </div>
                        <div class="col-sm-3">
                            <h2>
                                <div class="navbar-right">
                                    <form action="/experiment/configExperiment">
                                        <button type="submit" id="newExperimentButton"
                                                class="btn btn-default  btn-lg">
                                            <h4 style="margin-top: 0;margin-bottom: 0;">New experiment</h4>
                                        </button>
                                    </form>
                                </div>
                            </h2>
                        </div>
                    </div>
                </header>


                <section class="panel-body center-block">
                    <table class="table" id="expRepository" style="width: 100%;border-collapse: collapse;">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Experiment name</th>
                            <th scope="col">Experiment description</th>
                            <th scope="col">Last modification date</th>
                            <th scope="col"></th>
                            <th scope="col"></th>
                            <th scope="col" class="hidden">Experiment information</th>
                        </tr>
                        </thead>
                        <tbody id="expTableBody">
                        <th:block th:each="exp, iterStat : ${experimentList}">
                            <tr th:id="'tr' + ${iterStat.index}">
                                <td scope="row"><label th:name="id" th:text="${exp.id}" id="id"/>
                                </td>
                                <td scope="row"><label th:name="name"
                                                       th:text="${exp.experimentName}" id="name"/></td>
                                <td scope="row"><label th:name="description"
                                                       th:text="${exp.experimentDescription}" id="description"/>
                                </td>
                                <td scope="row">
                                    <span style="display:none;" th:text="${exp.getModificationDate()}"></span>
                                    <label th:name="creationDate"
                                                       th:text="${exp.getModificationDateFormated()}"
                                                       id="creationDate"/>
                                </td>
                                <td scope="row" class="details-control">
                                    <button type="button" class="btn-default btn btn-sm">More information
                                    </button>
                                </td>
                                <td scope="row">
                                    <form th:action="@{/experiment/expRepoSelected}" th:object="${expRepository}"
                                          method="GET">
                                        <input type="text" class="hidden" th:name="id"
                                               th:value="${exp.getId()}"/>
                                        <button type="submit"
                                                th:name="loadExperimentButton" class="btn-default btn btn-sm">Load
                                            experiment
                                        </button>
                                        <button type="button" name="deleteButton"
                                                th:id="${iterStat.index}"
                                                th:onclick="'confirmDelete(this.id,'+ ${exp.id}+')'"
                                                class="btn-default btn btn-sm"
                                                rel="tooltip"
                                                title="Delete experiment"
                                        ><span class="glyphicon glyphicon-trash small"></span></button>
                                    </form>
                                </td>
                                <!--with extra information-->
                                <td scope="control" class="hidden">
                                    <div>
                                        <b>Generations:</b>
                                        <label th:text="${exp.getGenerations()}"></label>
                                        ; <b>Crossover Prob:</b>
                                        <label th:text="${exp.getCrossoverProb()}"></label>
                                        ; <b>Population Size:</b>
                                        <label th:text="${exp.getPopulationSize()}"></label>
                                        ; <b>Mutation Prob:</b>
                                        <label th:text="${exp.getMutationProb()}"></label>
                                        ; <b>Max Wraps:</b>
                                        <label th:text="${exp.getMaxWraps()}"></label>
                                        ; <b>Num Codons:</b>
                                        <label th:text="${exp.getNumCodons()}"></label>
                                        ; <b>Tournament:</b>
                                        <label th:text="${exp.getTournament()}"></label>
                                        ; <b>Number Runs:</b>
                                        <label th:text="${exp.getNumberRuns()}"></label>
                                        ; <b>Objective:</b>
                                        <label th:text="${exp.getObjective()}"></label>
                                        </span>

                                    </div>
                                    <div th:if="${not #lists.isEmpty(exp.getIdRunList())}">
                                        <table class="table table-hover"
                                               th:name="runTable+${iterStat.index}"
                                               th:id="runTable+${iterStat.index}">
                                            <thead>
                                            <tr>
                                                <th scope="col"># Run</th>
                                                <th scope="col">Best solution</th>
                                                <th scope="col">Current generation</th>
                                                <th scope="col">Status</th>
                                                <th scope="col">Creation date</th>
                                                <th scope="col">Last modification date</th>
                                                <th scope="col">Model</th>
                                            </tr>
                                            </thead>
                                            <tbody>
                                            <th:block th:each="run, iterStat : ${exp.getIdRunList()}">
                                                <tr th:if="${run.getDiagramData()!=null}">
                                                    <td scope="row"><label th:text="${iterStat.index+1}"
                                                                           th:id="'runId'+${iterStat.index}"/></td>
                                                    <td scope="row"><label th:name="bestIndividual"
                                                                           th:id="'bestIndividual'+${iterStat.index}"
                                                                           th:text="${run.getDiagramData().bestIndividual}"/>
                                                    </td>
                                                    <td scope="row"><label th:name="currentGeneration"
                                                                           th:id="'currentGeneration'+${iterStat.index}"
                                                                           th:text="${run.getDiagramData().currentGeneration}"/>
                                                    </td>
                                                    <td scope="row"><label th:name="status"
                                                                           th:id="'status'+${iterStat.index}"
                                                                           th:text="${run.getStatus()}"/></td>
                                                    <td scope="row"><label th:name="iniDate" th:id="iniDate"
                                                                           th:text="${run.getIniDateFormated()}"/>
                                                    </td>
                                                    <td scope="row"><label th:name="lastDate" th:id="lastDate"
                                                                           th:text="${run.getModificationDateFormated()}"/>
                                                    </td>
                                                    <td scope="row"><label th:name="model"
                                                                           th:id="model+${iterStat.index}"
                                                                           th:text="${run.getModel()}"/></td>
                                                </tr>
                                            </th:block>
                                            <tr>
                                                <td colspan="7">
                                                        <b>Avg. :</b><label th:name="runsAVG+${iterStat.index}"
                                                                          th:id="runsAVG+${iterStat.index}"></label>
                                                        <b style="margin-left: 15px">Std. Dev: </b><label th:name="runsDeviation+${iterStat.index}"
                                                                              th:id="runsDeviation+${iterStat.index}"></label>
                                                        <b style="margin-left: 15px">Min: </b><label th:name="minBestSolution+${iterStat.index}"
                                                                          th:id="minBestSolution+${iterStat.index}"></label>
                                                        <b style="margin-left: 15px">Max: </b><label th:name="maxBestSolution+${iterStat.index}"
                                                                          th:id="maxBestSolution+${iterStat.index}"></label>
                                                    <button style="margin-left: 15px" class="btn-default btn btn-sm" th:onclick="'downloadExperimentRunResults('+${exp.getId()}+')'">Download results
                                                    </button>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </th:block>
                        </tbody>
                    </table>
                </section>
            </div>
        </div>
        <!-- END Main -->


        <!-- Modal -->
        <div id="detailsModal" class="modal fade" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Experiment details</h4>
                    </div>
                    <div class="modal-body">
                        <p>Details experiment.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                    </div>
                </div>

            </div>
        </div>
        <!-- END Modal -->
    </div>


    <script>
        $("#expTypeTable tr").attr({"id": "selected"}).siblings().removeAttr('id');
        $("#moreDetails").attr("")
    </script>

    <script>
        /*<![CDATA[*/
        let numberExperiment = [[${experimentList.size()}]];
        /*]]>*/

        $(document).ready(function () {
            for(let index = 0;index<numberExperiment;index++){
                let runTable = document.getElementById("runTable" + index)
                if(runTable){
                    calculateRunsStats(runTable, '#runsAVG' + index,
                        '#runsDeviation' + index,
                        '#maxBestSolution' + index,
                        '#minBestSolution' + index);
                    runTable = document.getElementById("runTable" + index)
                }
            }

            tableDefinition('#expRepository', "#expTableBody", 4, 5, 6, 3);
        });

        function confirmDelete(iterStat, expId) {

            $.ajax({
                url: encodeURI("/experiment/expRepoSelected"),
                data: {
                    'experimentId': expId,
                    'checkIfRunning' :'checkIfRunning'
                },
                cache: false,
                async: true,
                type: "POST",
                dataType: "json",
                success: function (running) {
                    if(!running){
                        let result = confirm("Are you sure to delete this experiment?");
                        if (result)
                            deleteRow(iterStat, expId);
                    }else{
                        alert("The experiment is currently running, wait until it has finished or stop it to delete it");
                    }
                }
            });

        }

        function deleteRow(iterStat, expId) {

            $.ajax({
                url: encodeURI("/experiment/expRepoSelected"),
                data: {
                    'experimentId': expId,
                    'deleteExperiment': 'deleteExperiment'
                },
                cache: false,
                async: true,
                type: "POST",
                dataType: "json",
                success: function () {
                    table.row($("#tr" + iterStat)).remove().draw();
                }
            });
        };

    </script>
</div>
</body>
</html>