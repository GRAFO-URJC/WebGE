<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}"
      lang="en">
<head>
    <title>WebGE - Experiment testing area</title>
    <script src="https://kit.fontawesome.com/0571a1ed47.js" crossorigin="anonymous"></script>
    <style>
        .tooltipcustom {
            font-size: inherit;
            line-height: inherit;
            position: inherit;
        }

        .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            left: 50%;
            margin-left: -75px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltipcustom:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }




    </style>
</head>

<!--
    Attribute th:field will replace attributes value, id and name in your input tag.
    Instead, use plain th:id, th:value and th:name without using th:field. Then you will get what you wanted.
-->
<body>
<div id="page" layout:fragment="content" message=${errorMessage}>
    <!-- Main -->
    <div class="container">
        <div id="forms" class="panel panel-default">
            <div class="alert alert-info hidden" id="messageModify">
                <label id="messageModifyText">
                </label>
            </div>
            <div th:if="${messageClone}" class="alert alert-info">
                <label th:text="${messageClone}" id="cloneMessage"></label>
            </div>
            <header class="panel-heading">
                <h2>Experiment configuration area</h2>
            </header>

            <section class="panel-body">
                <form th:action="@{/experiment/start}" th:object="${configExp}" enctype="multipart/form-data"
                      role="form" method="POST" onsubmit="
                      return checkDeletePreviousRun();
                        return checkNumberRuns();">

                    <div class="row center-block text-center form-horizontal">
                        <div class="col-sm-6 col-md-offset-3 col-lg-offset-3">
                            <div th:if="${messageSave}" th:id="messageSave" class="alert alert-info">
                                <label th:text="${messageSave}"></label>
                            </div>
                        </div>
                    </div>

                    <div class="row center-block form-horizontal">

                        <!-- Experiment NAME and DESCRIPTION -->
                        <div class="row form-group" th:if="${configuration.getId() != null}">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <input type="hidden" th:id="id" th:name="id" th:value="${configuration.getId()}"
                                       placeholder="Id of the experiment"/>
                            </div>
                        </div>

                        <div class="row form-group">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <!-- Error handling -->
                                <p class="text-warning"
                                   th:each="error: ${#fields.errors('experimentName')}"
                                   th:text="${error}">Validation error
                                </p>
                                <!-- END error handling -->
                                <div th:classappend="${#fields.hasErrors('experimentName')}? 'has-error':''">
                                    <input type="text" class="form-control " id="experimentName" name="experimentName"
                                           th:value="${configuration.getExperimentName()}"
                                           placeholder="Name of the experiment" required/>
                                </div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <!-- Error handling -->
                                <p class="text-warning"
                                   th:each="error : ${#fields.errors('experimentDescription')}"
                                   th:text="${error}">Validation error</p>
                                <!-- END error handling -->
                                <div th:classappend="${#fields.hasErrors('experimentDescription')}? 'has-error':'experimentDescription error'">
                                    <input type="text" class="form-control" id="experimentDescription"
                                           name="experimentDescription"
                                           th:value="${configuration.getExperimentDescription()}"
                                           placeholder="Description of the experiment"/>
                                </div>
                            </div>
                        </div>
                        <!-- END Experiment NAME and DESCRIPTION -->

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!-- Training Test Validation files -->
                        <div class="col-sm-12 col-md-12 col-lg-12 center-block">
                            <div class="jumbotron row form-group">
                                <h4>Tags</h4>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <input id="tagName" placeholder="Tag name" width="120%"/>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <button type="button" class = "btn" onclick="addTag()">Add new tag</button>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <input id="tagNameRemove" placeholder="Tag name" width="120%"/>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">
                                    <button type="button"  class = "btn"  onclick="removeTag()">Remove tag</button>
                                </div>
                                <div class="col-sm-4 col-md-4 col-lg-4">
                                    <button type="button" class = "btn btn-danger"  onclick="removeAllTags()">Remove all tags</button>
                                </div>

                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                <textarea rows="4" class="form-control" name="tagsText"
                                          id="tagsText" th:inline="text" style="resize: none;height: 50px"
                                          th:text="${configuration.getTagsText()}"
                                          placeholder="Tags"
                                          readonly ></textarea>
                                </div>


                            </div>
                        </div>

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!-- ExpPropertiesDto -->
                        <div class="col-sm-12 col-md-6 col-lg-6">
                            <div class="row form-group text-center">
                                <div class="jumbotron row form-group">
                                    <h4>Properties of the experiment</h4>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="generations">Generations:</label>
                                    <div th:classappend="${#fields.hasErrors('generations')}? 'has-error':'generations error'">
                                        <input type="number" class="text-center" style="width: 100%" th:min="1"
                                               th:value="${configuration.getGenerations()}" name="generations"
                                               id="generations"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="crossoverProb">Crossover Prob.:</label>
                                    <div th:classappend="${#fields.hasErrors('crossoverProb')}? 'has-error':'crossoverProb error'">
                                        <input type="number" class="text-center" th:min="0" th:max="1" th:step="0.01"
                                               style="width: 100%"
                                               th:value="${configuration.getCrossoverProb()}" name="crossoverProb"
                                               id="crossoverProb"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="populationSize">Population size:</label>
                                    <div th:classappend="${#fields.hasErrors('populationSize')}? 'has-error':'populationSize error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 100%"
                                               th:value="${configuration.getPopulationSize()}" name="populationSize"
                                               id="populationSize"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="mutationProb">Mutation Prob.:</label>
                                    <div style="width: 100%"
                                         th:classappend="${#fields.hasErrors('mutationProb')}? 'has-error':'mutationProb error'">
                                        <input style="width: 100%" type="number" class="text-center" th:min="0"
                                               th:max="1" th:step="0.01"
                                               th:value="${configuration.getMutationProb()}" name="mutationProb"
                                               id="mutationProb"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="maxWraps">Max wraps:</label>
                                    <div th:classappend="${#fields.hasErrors('maxWraps')}? 'has-error':'maxWraps error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 100%"
                                               th:value="${configuration.getMaxWraps()}" value="3" name="maxWraps"
                                               id="maxWraps"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="numCodons">Num. Codons:</label>
                                    <div th:classappend="${#fields.hasErrors('numCodons')}? 'has-error':'numCodons error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 100%"
                                               th:value="${configuration.getNumCodons()}" value="100" name="numCodons"
                                               id="numCodons"/>
                                    </div>
                                </div>
                                <div class='col-sm-12 col-md-6 col-lg-6'>
                                    <label for="tournament">Tournament:</label>
                                    <div th:classappend="${#fields.hasErrors('tournament')}? 'has-error':'tournament error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 80%"
                                               th:value="${configuration.getTournament()}" value="2" name="tournament"
                                               id="tournament"/>
                                    </div>
                                </div>
                                <div class='col-sm-12 col-md-6 col-lg-6'>
                                    <label for="numberRuns">Number of runs:</label>
                                    <div th:classappend="${#fields.hasErrors('numberRuns')}? 'has-error':'numberRuns error'">
                                        <input type="number" class="text-center" min="1" style="width: 80%"
                                               th:value="${configuration.getNumberRuns()}" value="1" name="numberRuns"
                                               id="numberRuns"/>
                                    </div>
                                </div>



                            </div>
                            <div class="row form-group text-center">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <label for="tournament">Objective function:</label>
                                    <select class="form-control" name="objective" id="objective">
                                        <option value="RMSE" id="RMSE"> Root Mean Squared Error (RMSE)</option>
                                        <option value="MSE" id="MSE"> Mean Squared Error (MSE)</option>
                                        <option value="R2" id="R2">R-Squared (R2)</option>
                                        <option value="ABS" id="ABS"> Absolute Error (ABS)</option>
                                        <option value="REL" id="REL"> Relative Error (REL)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row form-group text-center " style="border: 1px solid black">

                                <div class="col-sm-12 col-md-6 col-lg-4" style="padding-top: 20px">
                                    <label for="de">GE + DE: </label>
                                    <input type="checkbox" name="de" id="de"
                                           th:checked="${configExp.isDe()}" onclick="setDE()"
                                    />
                                </div>

                                <div class="col-sm-12 col-md-6 col-lg-4" hidden id="lowerbound_col">
                                    <label for="lowerboundDE">Param. Lower Bound:</label>
                                    <div class = "tooltipcustom">
                                        <span class = "tooltiptext">Maximum value for model parameters</span>
                                        <input type="number" class="text-center"  th:step="0.01" style="width: 100%"
                                               th:value="${configuration.getLowerBoundDE()}" name="lowerboundDE"
                                               id="lowerboundDE"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4" hidden id="upperbound_col">
                                    <label for="uperboundDE">Param. Upper Bound:</label>
                                    <div class = "tooltipcustom">
                                        <span class = "tooltiptext">Maximum value for model parameters</span>
                                        <input type="number" class="text-center" th:step="0.01"
                                               style="width: 100%"
                                               th:value="${configuration.getUpperBoundDE()}" name="uperboundDE"
                                               id="uperboundDE"/>
                                    </div>

                                </div>

                                <div class="row form-group text-center">
                                    <div class='col-sm-12 col-md-6 col-lg-4' hidden id="recombinationfactor_col">
                                        <label for="recombinationFactorDE">Recombination Factor:</label>
                                        <div>
                                            <input type="number" class="text-center" th:min="0"  th:max="1" th:step="0.01"
                                                   style="width: 100%"
                                                   th:value="${configuration.getRecombinationFactorDE()}" name="recombinationFactorDE"
                                                   id="recombinationFactorDE"/>
                                        </div>
                                    </div>
                                    <div class='col-sm-12 col-md-6 col-lg-4' hidden id="mutationfactor_col">
                                        <label for="mutationFactorDE">Mutation Factor:</label>
                                        <div>
                                            <input type="number" class="text-center" th:min="0"
                                                   th:max="1" th:step="0.01"
                                                   style="width: 100%"
                                                   th:value="${configuration.getMutationFactorDE()}" name="mutationFactorDE"
                                                   id="mutationFactorDE"/>
                                        </div>
                                    </div>

                                    <div class='col-sm-12 col-md-6 col-lg-4' hidden id="populationDE_col">
                                        <label for="populationDE">Population Size:</label>
                                        <div>
                                            <input type="number" class="text-center" th:min="4"
                                                   th:step="1"
                                                   style="width: 100%"
                                                   th:value="${configuration.getPopulationDE()}" name="populationDE"
                                                   id="populationDE"/>
                                        </div>
                                    </div>

                                </div>
                            </div>





                        </div>
                        <!-- END ExpPropertiesDto -->

                        <!-- Grammar file -->
                        <div class="col-sm-12 col-md-6 col-lg-6 center-block">
                            <div class="jumbotron row form-group">
                                <h4>Grammar</h4>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <label>Copy from: </label>
                                </div>
                                <div class="col-sm-7 col-md-7 col-lg-7">
                                    <select id="grammarSelect" name="grammarSelect" style="width: 100%">
                                        <option value="">Select a grammar ...</option>
                                        <option th:each="gr,iterStat : ${grammarList}" th:value="${iterStat.index}"
                                                th:text="${gr.getGrammarName() + ' - ' + gr.getGrammarDescription()}"
                                                data-toggle="tooltip"
                                                th:title="${gr.getFileText()}"/>
                                    </select>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">

                                    <div class="tooltip">
                                        <button id="copyGrammarButton"
                                                type="button" class = "btn"
                                                onclick="copyGrammar()" onmouseout="onGrammar()">
                                            <span class="tooltiptext" id="grammarTooltip">Copy grammar</span>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <textarea rows="8" class="form-control" name="fileText"
                                              id="fileText" th:inline="text" style="resize: none;height: 180px"
                                              th:text="${configExp.getFileText()}" placeholder="Grammar content"
                                              required></textarea>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-6 col-md-6 col-lg-6">
                                    <input id="grammarName" placeholder="Grammar name"/>
                                </div>
                                <div class="col-sm-6 col-md-6 col-lg-6">
                                    <button type="button" class = "btn" onclick="storeGrammar()">Store as new grammar</button>
                                </div>
                                <div class="col-sm-12 col-md-12 col-lg-12" style="margin-top: 5px">
                                    <input id="grammarDescription" placeholder="Grammar description"
                                           style="width: 100%"/>
                                </div>
                            </div>


                        </div>
                        <!-- END Grammar file -->

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!-- Training Test Validation files -->
                        <div class="col-sm-12 col-md-12 col-lg-12 center-block">
                            <div class="jumbotron row form-group">
                                <h4>Training Dataset</h4>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm12 col-md-12 col-lg-12">
                                    <select id="datasetId" name="datasetId"
                                            onchange="updateDatasetContent()" required>
                                        <option value="">Select a dataset ...</option>
                                        <option th:each="dataset,ite : ${datasetList}" th:value="${ite.index}"
                                                th:text="${dataset.getDataTypeName() + ' - ' + dataset.getDataTypeDescription()}"
                                                th:selected="(${(experimentDataType !=null) && (experimentDataType.getId() == dataset.getId())})"/>
                                    </select>
                                    <input id="experimentDataTypeId" name="experimentDataTypeId" hidden="true"/>
                                </div>
                                <div th:class="${configExp.getCrossExperiment().equals('true')||configExp.isContentFold()?'col-sm-12 col-md-12 col-lg-12 '
                                :'col-sm-12 col-md-12 col-lg-12 hidden'}" id="crossExperimentSection">
                                    <input id="crossExperiment" name="crossExperiment" type="checkbox"
                                           th:value="${configExp.getCrossExperiment().equals('true')}"
                                           th:checked="${configExp.getCrossExperiment().equals('true')}">
                                    Cross-validation run
                                </div>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-8">
                                    <input type="text" class="form-control" name="dataTypeName" id="dataTypeName"
                                           placeholder="Name of dataset"
                                           readonly/>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12"><input type="text" class="form-control"
                                                                                  name="dataTypeDescription"
                                                                                  id="dataTypeDescription"
                                                                                  placeholder="Description of the file"
                                                                                  readonly/>
                                </div>
                            </div>

                            <div class="row form-group text-center">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                <textarea rows="5" class="form-control" name="info"
                                          id="info" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- END Training Test Validation files -->
                        <!-- Test Test files -->
                        <div th:class="${configExp.getCrossExperiment().equals('true')?'col-sm-12 col-md-12 col-lg-12 center-block hidden'
                                :'col-sm-12 col-md-12 col-lg-12 center-block'}" id="testDatasetPart">
                            <div class="jumbotron row form-group">
                                <h4>Test Dataset</h4>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <select id="testDatasetId" name="testDatasetId"
                                            onchange="updateTestDatasetContent()">
                                        <option value="">Select a dataset ...</option>
                                        <option th:each="dataset,ite : ${datasetList}" th:value="${ite.index}"
                                                th:text="${dataset.getDataTypeName() + ' - ' + dataset.getDataTypeDescription()}"
                                                th:selected="(${(testExperimentDataType !=null) && (testExperimentDataType.getId() == dataset.getId())})"/>
                                    </select>
                                    <input id="testExperimentDataTypeId" name="testExperimentDataTypeId" hidden="true"/>
                                </div>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-8">
                                    <input type="text" class="form-control" name="testDataTypeName"
                                           id="testDataTypeName"
                                           placeholder="Name of dataset"
                                           readonly/>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <input type="text" class="form-control" name="testDataTypeDescription"
                                           id="testDataTypeDescription"
                                           placeholder="Description of the file" readonly/>
                                </div>
                            </div>

                            <div class="row form-group text-center">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                <textarea rows="5" class="form-control" name="testInfo"
                                          id="testInfo" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- END Test dataset-->

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!--  Save Clone and Run -->
                        <div class="row text-center">
                            <div class="col-sm-12 col-md-4 col-lg-4" style="margin-bottom:2px">
                                <button type="submit" id="saveExperimentButton" name="saveExperimentButton"
                                        onclick="saveButton=true;runButton=false;"
                                        class="btn-primary btn-lg btn">Save experiment
                                </button>
                            </div>
                            <div class="col-sm-12 col-md-4 col-lg-4">
                                <button type="submit" id="cloneExperimentButton" name="cloneExperimentButton"
                                        class="btn-primary btn-lg btn" th:disabled="${disabledClone!=null}"
                                        onclick="cloneButton=true;">Clone
                                    experiment
                                </button>
                            </div>
                            <div class="col-sm-12 col-md-4 col-lg-4">
                                <button type="submit" id="runExperimentButton" name="runExperimentButton"
                                        class="btn-primary btn-lg btn"
                                        onclick="runButton=true;saveButton=false;">Save and run experiment
                                </button>
                            </div>
                        </div>
                        <!-- END Save Clone and Run -->
                    </div>
                </form>

            </section>
        </div>

        <!-- END Main -->

    </div>
    <!-- RUN SECTION -->
    <div class="container" th:if="${runList!=null && not #lists.isEmpty(runList)}">
        <div id="runForms" class="panel panel-default">
            <header class="panel-heading">
                <h2>List of runs
                    <button type="button" name="stopAllRuns" id="stopAllRuns" onclick="stopAllRuns()"
                            class="btn-danger btn btn-md" style="float: right;margin-right: 40px;" rel="tooltip"
                            title="Stop all runs">Stop all runs
                    </button>
                </h2>

            </header>

            <section class="panel-body">
                <table class="table table-hover" id="expTypeTable">
                    <caption class="hidden">Experiment Type Table</caption>
                    <thead>
                    <tr>
                        <th scope="col"># Run</th>
                        <th scope="col">Best solution</th>
                        <th scope="col">Current generation</th>
                        <th scope="col">Status</th>
                        <th scope="col">Creation date</th>
                        <th scope="col">Last modification date</th>
                        <th scope="col">Model</th>
                        <th scope="col" style="width:1%"></th>
                    </tr>
                    </thead>
                    <tbody>

                    <th:block th:each="run, iterStat : ${runList}">
                        <tr th:id="'tr' + ${iterStat.index}">
                            <td id="index">
                                <label th:text="${iterStat.index+1}"/>
                                <label th:text="${run.getId()}"
                                       th:id="'runId'+${iterStat.index}" hidden/></td>
                            <td id="bestIndividual"><label th:name="bestIndividual"
                                                           th:id="'bestIndividual'+${iterStat.index}"
                                                           th:text="${run.getDiagramData()!=null?
                                                       run.getDiagramData().bestIndividual:'0'}"/></td>
                            <td id="currentGen"><label th:name="currentGeneration"
                                                       th:id="'currentGeneration'+${iterStat.index}"
                                                       th:text="${run.getDiagramData()!=null?
                                                       run.getDiagramData().currentGeneration:'0'}"/>
                            </td>
                            <td id="status"><label th:name="status" th:id="'status'+${iterStat.index}"
                                                   th:text="${run.getStatus()}"/></td>
                            <td id="iniDate"><label th:name="iniDate" th:id="iniDate"
                                                    th:text="${run.getIniDateFormated()}"/></td>
                            <td id="lastDate"><label th:name="lastDate" th:id="lastDate+${iterStat.index}"
                                                     th:text="${run.getModificationDateFormated()}"/></td>
                            <td id="model"><label th:name="model" th:id="model+${iterStat.index}"
                                                  th:text="${run.getModel()}"/></td>
                            <td id="stopExec">
                                <div th:id="${'stopRunSection' + iterStat.index}"
                                     th:class="${run.getStatus().toString().equals('RUNNING')?'':'hidden'}"
                                     style="display:inline">
                                    <button type="button" th:name="${run.id}"
                                            th:id="${'stopRun' + iterStat.index}"
                                            onclick="stopRun(this.id, this.name)"
                                            class="btn-default btn"
                                            rel="tooltip"
                                            title="Stop run execution"
                                    ><span class="fas fa-stop"></span>
                                    </button>
                                </div>
                                <div th:id="'showPlot'+${iterStat.index}" class="hidden" style="display:inline">
                                    <a th:href="@{/experiment/runList(runId=${run.getId()}, showPlotExecutionButton='showPlotExecutionButton')}"
                                       target="_blank" class="btn-default btn loadButton" rel="tooltip" title="Show plot"><span class="fas fa-chart-area"></span></a>
                                </div>
                                <div th:id="'showDelete'+${iterStat.index}" style="display:inline">
                                    <a th:id="'showTestStats'+${iterStat.index}"
                                       th:href="@{/experiment/runList(runId=${run.getId()}, showTestStatsPlotButton='showTestStatsPlotButton')}"
                                       target="_blank" class="btn-default btn loadButton"
                                       th:disabled="${run.getStatus().toString().equals('FAILED')}" rel="tooltip" title="See stats"
                                    ><span class="fas fa-stream"></span></a>
                                    <button type="button" th:name="${run.id}"
                                            th:id="${'deleteRun' + iterStat.index}"
                                            onclick="confirmDelete(this.id, this.name)"
                                            class="btn-default btn"
                                            rel="tooltip"
                                            title="Delete run"
                                    ><span
                                            class="fas fa-trash"></span></button>
                                </div>
                            </td>
                        </tr>
                    </th:block>
                    <tr>
                        <td colspan="9">
                            <strong>Avg.: </strong><label id="runsAVG">Waiting runs</label>
                            <strong style="margin-left: 15px">Std. Dev: </strong><label id="runsDeviation">Waiting
                            runs</label>
                            <strong style="margin-left: 15px">Min: </strong><label id="minBestSolution">Waiting
                            runs</label>
                            <strong style="margin-left: 15px">Max: </strong><label id="maxBestSolution">Waiting
                            runs</label>
                            <button style="margin-left: 15px" class="btn-default btn btn-sm"
                                    th:onclick="'downloadExperimentRunResults('+${configExp.getId()}+')'">Download
                                results
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>

            </section>
        </div>
    </div>
    <!-- END RUN SECTION -->


    <script th:inline="javascript">

        let countModify = 0;
        let cloneButton = false;
        let datasetListInfo = [];
        let data = {};
        let indexesShow = [];
        let indexesHide = [];
        let experimentInformation;
        let runButton = false;
        let saveButton = false;
        let grammarList;
        let grammarTooltip = document.getElementById("grammarTooltip");
        let runTable = document.getElementById("expTypeTable");
        let checkedCrossValidationValue = -1;

        function addTag(){

        let tempTag = '';
            if ($("#tagName").val()) {
            tags = $('#tagsText').val().split("; ");
            tags.pop();
                const found = tags.indexOf($("#tagName").val());
                if(found == -1){
                    tags.push($("#tagName").val());
                    tags.sort();
                    tags.forEach(function(item, index, array){
                        tempTag += item+"; ";

                    })
                    $("#tagsText").val(tempTag)
                }
                $("#tagName").val("");
            }
        }

        function removeTag(){
         let tempTag = '';
            if ($("#tagNameRemove").val()) {
                let indexEl = tags.indexOf($("#tagNameRemove").val());
                if(indexEl != -1){
                    tags.splice(indexEl, 1);

                    tags.forEach(function(item, index, array){
                        tempTag += item+"; ";

                    })
                    $("#tagsText").val(tempTag)
                }
                $("#tagNameRemove").val("");
            }

        }

        function removeAllTags(){
            let result = confirm("Are you sure of removing all tags?");
            if (result){
                $("#tagsText").val("");
            }
        }

        function storeGrammar(){
            let grammarName = $("#grammarName").val();
            let grammarDescription = $("#grammarDescription").val();
            let grammarContent = $("#fileText").val();

            if (grammarContent == "" || grammarName == "" || grammarDescription== "") {
                alert("Grammar name, description and content cannot be empty");
                return;
            }

            $.ajax({
                    url: encodeURI("/grammar/ajaxSaveGrammar"),
                    data: {
                        'grammarName': grammarName,
                        'grammarDescription': grammarDescription,
                        'grammarContent': grammarContent,
                    },
                    async: true,
                    type: "POST",
                    success: function (existed) {
                        if(existed){
                            alert("There is already a grammar with that name");
                        }else{
                            alert("New grammar saved");
                        }
                    },
                    error: function () {
                        alert("Fail on saving the new grammar");
                    }
                });

        }

        $(document).ready(function () {
            /*<![CDATA[*/
            experimentInformation = [[${configuration}]];
            grammarList = [[${grammarList}]];
            /*]]>*/

            saveDatasetInfo();
            updateDatasetContent()
            updateTestDatasetContent()
            setObjectiveFunction();
            setDE();
            checkStopAllRuns()


            $('[name="status"]').each(function (index) {
                if (($(this).text() == "FINISHED") || ($(this).text() == "STOPPED") || ($(this).text() == "FAILED") || ($(this).text() == "CANCELLED")) {
                    indexesShow[index] = index;
                }
                if (($(this).text() == "RUNNING") || ($(this).text() == "INITIALIZING") || ($(this).text() == "WAITING")) {
                    indexesHide[index] = index;
                    showRunStatus("runExperimentButton" + index);
                }

            });

            indexesShow.forEach(function (element, index) {
                $("#runExperimentButton" + indexesShow[index]).removeClass("hidden");
                $("#showDelete" + indexesShow[index]).removeClass("hidden");
                $("#showPlot" + indexesShow[index]).removeClass("hidden");
            });

            indexesHide.forEach(function (element, index) {
                $("#showDelete" + indexesHide[index]).addClass("hidden");
                $("#runExperimentButton" + indexesShow[index]).addClass("hidden");
            });

            calculateRunsStats(runTable, '#runsAVG', '#runsDeviation', '#maxBestSolution', '#minBestSolution');
            checkStopAllRuns()
            //all input check
            $("input").change(function () {
                if (this.id != "grammarName" && this.id != "grammarDescription") {
                    countModify = this.value == experimentInformation[this.id] ? countModify - 1 : countModify + 1;
                    checkShowAlert(this.id)
                }
            })
            //grammar check
            $("#fileText").change(function () {
                countModify = experimentInformation[this.id].split(/[\s]+/).join() === this.value.split(/[\s]+/).join() ?
                    countModify - 1 : countModify + 1;
                checkShowAlert(this.id)
            })
            //dataset check
            $("#datasetId").change(function () {
                countModify = experimentInformation['defaultExpDataTypeId'] == $('#experimentDataTypeId').val() ?
                    countModify - 1 : countModify + 1;
                checkShowAlert(this.id);
            })


            if (document.getElementById("crossExperiment").checked) {
                checkedCrossValidationValue = $("#datasetId option:selected").val();
            }

        });


        function setObjectiveFunction(){

            $('[name=objective ] option').filter(function() {
                return ($(this).val() == experimentInformation['objective']);
            }).prop('selected', true);


        }



        function copyGrammar() {
            if (grammarList[$("#grammarSelect").val()]) {
                $("#fileText").val(grammarList[$("#grammarSelect").val()].fileText);
                grammarTooltip.innerHTML = "Copied";
            }
        }

        function onGrammar() {
            grammarTooltip.innerHTML = "Copy grammar";
        }

        function updateDatasetContent() {
            if ($('#datasetId').val() != "") {
                let i = parseInt($('#datasetId').val());
                $('#dataTypeName').val(datasetListInfo[i].dataTypeName);
                $('#dataTypeDescription').val(datasetListInfo[i].dataTypeDescription);
                $('#info').val(datasetListInfo[i].info);
                $('#experimentDataTypeId').val(datasetListInfo[i].idDataset);
            } else {
                $('#dataTypeName').val("");
                $('#dataTypeDescription').val("");
                $('#info').val("");
            }
        }

        function updateTestDatasetContent() {
            if ($('#testDatasetId').val() != "") {
                let i = parseInt($('#testDatasetId').val());
                $('#testDataTypeName').val(datasetListInfo[i].dataTypeName);
                $('#testDataTypeDescription').val(datasetListInfo[i].dataTypeDescription);
                $('#testInfo').val(datasetListInfo[i].info);
                $('#testExperimentDataTypeId').val(datasetListInfo[i].idDataset);
            } else {
                $('#testDataTypeName').val("");
                $('#testDataTypeDescription').val("");
                $('#testInfo').val("");
                $('#testExperimentDataTypeId').val("");
            }
        }

        function saveDatasetInfo() {
            /*<![CDATA[*/
            /*[# th:each="dataset : ${datasetList}"]*/
            data = {};
            data.idDataset =/*[[${dataset.getId()}]]*/;
            data.dataTypeName =/*[[${dataset.getDataTypeName()}]]*/;
            data.dataTypeDescription =/*[[${dataset.getDataTypeDescription()}]]*/;
            data.info =/*[[${dataset.getInfo()}]]*/;
            data.foldSize =/*[[${dataset.getFoldSize()}]]*/;
            datasetListInfo.push(data);
            /*[/]*/
            /*]]>*/
        }

        function setDE(){
             $('#de').val(document.getElementById('de').checked);

             if(document.getElementById('de').checked){
                $('#lowerbound_col').attr('hidden', false)
                $('#upperbound_col').attr('hidden', false)
                $('#recombinationfactor_col').attr('hidden', false)
                $('#mutationfactor_col').attr('hidden', false)
                $('#populationDE_col').attr('hidden', false)
            }else{
               $('#lowerbound_col').attr('hidden', 'hidden')
                $('#upperbound_col').attr('hidden', 'hidden')
                $('#recombinationfactor_col').attr('hidden', 'hidden')
                $('#mutationfactor_col').attr('hidden', 'hidden')
                 $('#populationDE_col').attr('hidden', 'hidden')
            }

        }

        function checkRunStatus(runId, status, bestIndividual, currentGeneration, model, iterStat) {
            $.ajax({
                url: encodeURI("/rest/runStatus/"),
                data: {
                    'runId': runId.text(),
                    'status': $(status).text()
                },
                cache: false,
                async: true,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    let statusStr = data['status'];
                    let bestIndividualStr = data['bestIndividual'];
                    let currentGenerationStr = data['currentGeneration'];
                    let lastDate = data['modificationDateFormated'];

                    let modelStr = data['model'] === "" ? "Waiting for finish" : data['model'];
                    modelStr = data['status'] === ("CANCELLED" || "STOPPED") ? " " : modelStr;

                    $(status).text(statusStr);
                    $(bestIndividual).text(bestIndividualStr);
                    $(currentGeneration).text(currentGenerationStr);
                    $(model).text(modelStr);
                    $('#lastDate' + iterStat).text(lastDate);
                },
                complete: function () {
                    let runId = $("#runId" + iterStat);
                    let status = "#status" + iterStat;
                    let currentGeneration = "#currentGeneration" + iterStat;
                    let bestIndividual = "#bestIndividual" + iterStat;

                    if ($(status).text() === "RUNNING") {
                        $("#showPlot" + iterStat).removeClass("hidden");
                        $("#stopRunSection" + iterStat).removeClass("hidden");
                    }

                    if (($(status).text() != "FINISHED") && ($(status).text() != "STOPPED") && ($(status).text() != "FAILED")
                     && ($(status).text() != "CANCELLED")) {
                        $("#runExperimentButton" + iterStat).addClass("hidden");
                        $("#showDelete" + iterStat).addClass("hidden");
                        setTimeout(function () {
                            checkRunStatus(runId, status, bestIndividual, currentGeneration, model, iterStat);
                        }, 2000);
                    }

                    if (($(status).text() == "FINISHED") || ($(status).text() == "STOPPED") || ($(status).text() == "FAILED") ) {
                        if ($(status).text() == "FAILED" || ($(status).text() == "STOPPED")  ) {
                            document.getElementById("showTestStats" + iterStat).setAttribute("disabled", "disabled");
                        }

                        $("#showPlot" + iterStat).removeClass("hidden");
                        $("#showDelete" + iterStat).removeClass("hidden");
                        $("#stopRunSection" + iterStat).addClass("hidden");
                        $("#runExperimentButton" + iterStat).removeClass("hidden");
                        if ($(model).text() === "Waiting for finish" && ($(status).text() == "FINISHED")) {
                            setTimeout(function () {
                                checkRunStatus(runId, status, bestIndividual, currentGeneration, model, iterStat);
                            }, 2000);
                        }
                        calculateRunsStats(runTable, '#runsAVG', '#runsDeviation', '#maxBestSolution', '#minBestSolution');
                        checkStopAllRuns()
                    }
                    if ($(status).text() == "CANCELLED") {
                        $("#showDelete" + iterStat).removeClass("hidden");
                        document.getElementById("showTestStats" + iterStat).setAttribute("disabled", "disabled");
                    }
                }
            });
        };

        function showRunStatus(iterStat) {
            let cleanIterStat = iterStat.substring("runExperimentButton".length, iterStat.length);

            let runId = $("#runId" + cleanIterStat);
            let status = "#status" + cleanIterStat;
            let currentGeneration = "#currentGeneration" + cleanIterStat;
            let bestIndividual = "#bestIndividual" + cleanIterStat;
            let model = "#model" + cleanIterStat;

            setTimeout(function () {
                checkRunStatus(runId, status, bestIndividual, currentGeneration, model, cleanIterStat)
            }, 2000);
        }

        function confirmDelete(iterStat, runId) {
            let result = confirm("Are you sure of deleting this run?");
            if (result){
                deleteRow(iterStat, runId);

            }
        }

        function stopRun(iterStat, runId) {
            if (confirm("Are you sure of stopping this run?")) {
                let cleanIterStat = iterStat.substring("stopRun".length, iterStat.length);

                $.ajax({
                    url: encodeURI("/experiment/stopRunAjax"),
                    data: {
                        'runIdStop': runId,
                    },
                    cache: false,
                    async: true,
                    type: "POST",
                    dataType: "json",
                    success: function () {
                        $("#stopRunSection" + cleanIterStat).addClass("hidden");

                    }
                });
            }
        }

        function stopAllRuns(){
            if (confirm("Are you sure of stopping or cancelling all runs?")) {
                $.ajax({
                    url: encodeURI("/experiment/stopAllRunsAjax"),
                    data: {
                        'expId' : $('#id').val(),
                    },
                    cache: false,
                    async: true,
                    type: "POST",
                    dataType: "json",
                    success: function () {
                       alert("All runs have been canceled properly");
                        $('#stopAllRuns').addClass('disabled');
                    }
                });
            }

        }

        function deleteRow(iterStat, runId) {
            let cleanIterStat = iterStat.substring("deleteRun".length, iterStat.length);

            $.ajax({
                url: encodeURI("/experiment/expRepoSelected"),
                data: {
                    'runId': runId,
                    'deleteRun': 'deleteRun'
                },
                cache: false,
                async: true,
                type: "POST",
                dataType: "json",
                success: function (data) {
                    $("#tr" + cleanIterStat).remove();
                    $("#trAux" + cleanIterStat).remove();
                    calculateRunsStats(runTable, '#runsAVG', '#runsDeviation', '#maxBestSolution', '#minBestSolution');
                    disableStopAllRunsIfNoRuns();
                }
            });
        }

        function disableStopAllRunsIfNoRuns(){
            var x = document.getElementById("expTypeTable").rows.length;
            if(x<3){
                document.getElementById("stopAllRuns").setAttribute("disabled", "disabled");
            }

        }

        function checkStopAllRuns(){
            let able = false;
            for(let i = 0; i < document.getElementById("expTypeTable").rows.length-2; i++){
                if ($('#status' + i)[0].innerHTML == 'WAITING' || $('#status' + i)[0].innerHTML == 'RUNNING'){
                    able = true;
                }
            }
            if(able == true){
                $('#stopAllRuns').removeClass('disabled');
            }else{
                $('#stopAllRuns').addClass('disabled');
            }
        }

        function checkNumberRuns() {
            let numberRuns = document.getElementById("numberRuns");
            if (document.getElementById("crossExperiment").checked && numberRuns.value < datasetListInfo[$("#datasetId option:selected").val()].foldSize) {
                numberRuns.value = datasetListInfo[$("#datasetId option:selected").val()].foldSize;
            }
            return true;
        }

        function checkDeletePreviousRun() {
            if (document.getElementById("runForms") && !cloneButton && !(saveButton && checkExperimentInformationEqual())) {
                if (saveButton) {
                    return confirm('Saving will delete previous runs. Do you want to save the experiment?');
                }
                return confirm('Running will delete previous runs. Do you want to run the experiment?');

            } else {
                return true;
            }
        }

        function checkExperimentInformationEqual() {

            let generations = $('#generations').val();
            let crossoverProb = $('#crossoverProb').val();
            let populationSize = $('#populationSize').val();
            let mutationProb = $('#mutationProb').val();
            let maxWraps = $('#maxWraps').val();
            let numCodons = $('#numCodons').val();
            let tournament = $('#tournament').val();
            let numberRuns = $('#numberRuns').val();
            let objective = $('#objective').val();
            let de = $('#de').val();
            let grammar = $('#fileText').val();
            let datasetId = $('#experimentDataTypeId').val();
            let tagsText = $('#tagsText').val();
            let mutationfactorDE = $('#mutationFactorDE').val();
            let recombinationFactorDE = $('#recombinationFactorDE').val();
            let populationDE = $('#populationDE').val();

            experimentInformation['defaultExpDataTypeId'] =
                experimentInformation['defaultExpDataTypeId'] == null ? "" : experimentInformation['defaultExpDataTypeId'];

            return (
                experimentInformation['generations'] == generations &&
                experimentInformation['crossoverProb'] == crossoverProb &&
                experimentInformation['populationSize'] == populationSize &&
                experimentInformation['mutationProb'] == mutationProb &&
                experimentInformation['maxWraps'] == maxWraps &&
                experimentInformation['numCodons'] == numCodons &&
                experimentInformation['tournament'] == tournament &&
                experimentInformation['numberRuns'] == numberRuns &&
                experimentInformation['de'].toString() == de &&
                experimentInformation['objective'] == objective &&
                experimentInformation['tagsText'] == tagsText &&
                experimentInformation['mutationfactorDE'] == mutationfactorDE &&
                experimentInformation['recombinationFactorDE'] == recombinationFactorDE &&
                experimentInformation['populationDE'] == populationDE &&
                grammar.split(/[\s]+/).join() == experimentInformation['fileText'].split(/[\s]+/).join() &&
                experimentInformation['defaultExpDataTypeId'] == datasetId);
        }

        window.onbeforeunload = function (e) {

            let experimentName = $('#experimentName').val();
            let experimentDescription = $('#experimentDescription').val();
            let nameDescriptionChange = (experimentInformation['experimentName'] === experimentName &&
                experimentInformation['experimentDescription'] === experimentDescription);
            console.log(experimentInformation['de'].toString() == $('#de').val() )
            if ((document.getElementById("cloneMessage") && !runButton && !saveButton)
                || ((!checkExperimentInformationEqual() || !nameDescriptionChange) && !runButton && !saveButton)) {

                return 'Sure?';
            }
        }

        function checkShowAlert(identifier) {
            if (countModify > 0) {
                $("#messageModify").removeClass("hidden");
                $("#" + identifier).css("border-color", "#c09853")
            } else {
                $("#messageModify").addClass("hidden");
                $("#" + identifier).css("border-color", "")
            }
            $("#messageModifyText").text("The experiment has been modified.")
        }

        //dataset check
        $("#datasetId").change(function () {
            if (datasetListInfo[$("#datasetId option:selected").val()].info.includes("K-Fold")) {
                $("#crossExperimentSection").removeClass("hidden");
            } else {
                $("#crossExperimentSection").addClass("hidden");
            }

            if ($("#datasetId option:selected").val() === checkedCrossValidationValue) {
                document.getElementById("crossExperiment").checked = true;
            } else {
                document.getElementById("crossExperiment").checked = false;
            }

        })
        $("#crossExperiment").change(function () {
            this.value = this.checked;
            if (this.checked) {
                $("#testDatasetPart").addClass("hidden");
                $("#numberRuns").val(datasetListInfo[$("#datasetId option:selected").val()].foldSize);
                document.getElementById("numberRuns").min = datasetListInfo[$("#datasetId option:selected").val()].foldSize;
                alert("Number of runs set to " + datasetListInfo[$("#datasetId option:selected").val()].foldSize);
            } else {
                document.getElementById("numberRuns").min = 0
                $("#testDatasetPart").removeClass("hidden");
            }
        })





    </script>
</div>
</body>
</html>