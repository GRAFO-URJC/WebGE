<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/default}"
      lang="en">
<head>
    <title>WebGE - Experiment testing area</title>
    <style>
        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 140px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 150%;
            left: 50%;
            margin-left: -75px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .tooltip .tooltiptext::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #555 transparent transparent transparent;
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>

<!--
    Attribute th:field will replace attributes value, id and name in your input tag.
    Instead, use plain th:id, th:value and th:name without using th:field. Then you will get what you wanted.
-->
<body>
<div id="page" layout:fragment="content" message=${errorMessage}>
    <!-- Main -->
    <div class="container">
        <div id="forms" class="panel panel-default">
            <div class="alert alert-info hidden" id="messageModify">
                <label id="messageModifyText">
                </label>
            </div>
            <div th:if="${messageClone}" class="alert alert-info">
                <label th:text="${messageClone}" id="cloneMessage"></label>
            </div>
            <header class="panel-heading">
                <h2>Experiment configuration area</h2>
            </header>

            <section class="panel-body">
                <form th:action="@{/experiment/start}" th:object="${configExp}" enctype="multipart/form-data"
                      role="form" method="POST" onsubmit="return checkDeletePreviousRun();">

                    <div class="row center-block text-center form-horizontal">
                        <div class="col-sm-6 col-md-offset-3 col-lg-offset-3">
                            <div th:if="${messageSave}" th:id="messageSave" class="alert alert-info">
                                <label th:text="${messageSave}"></label>
                            </div>
                        </div>
                    </div>

                    <div class="row center-block form-horizontal">
                        <!-- Experiment NAME and DESCRIPTION -->
                        <div class="row form-group" th:if="${configuration.getId() != null}">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <input type="hidden" th:id="id" th:name="id" th:value="${configuration.getId()}"
                                       placeholder="Id of the experiment"/>
                            </div>
                        </div>

                        <div class="row form-group">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <!-- Error handling -->
                                <p class="text-warning"
                                   th:each="error: ${#fields.errors('experimentName')}"
                                   th:text="${error}">Validation error
                                </p>
                                <!-- END error handling -->
                                <div th:classappend="${#fields.hasErrors('experimentName')}? 'has-error':''">
                                    <input type="text" class="form-control " id="experimentName" name="experimentName"
                                           th:value="${configuration.getExperimentName()}"
                                           placeholder="Name of the experiment" required/>
                                </div>
                            </div>
                        </div>
                        <div class="row form-group">
                            <div class="col-sm-12 col-md-12 col-lg-12">
                                <!-- Error handling -->
                                <p class="text-warning"
                                   th:each="error : ${#fields.errors('experimentDescription')}"
                                   th:text="${error}">Validation error</p>
                                <!-- END error handling -->
                                <div th:classappend="${#fields.hasErrors('experimentDescription')}? 'has-error':'experimentDescription error'">
                                    <input type="text" class="form-control" id="experimentDescription"
                                           name="experimentDescription"
                                           th:value="${configuration.getExperimentDescription()}"
                                           placeholder="Description of the experiment"/>
                                </div>
                            </div>
                        </div>
                        <!-- END Experiment NAME and DESCRIPTION -->

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!-- ExpPropertiesDto -->
                        <div class="col-sm-12 col-md-6 col-lg-6">
                            <div class="row form-group text-center">
                                <div class="jumbotron row form-group">
                                    <h4>Properties of the experiment</h4>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="generations">Generations:</label>
                                    <div th:classappend="${#fields.hasErrors('generations')}? 'has-error':'generations error'">
                                        <input type="number" class="text-center" style="width: 100%" th:min="100"
                                               th:value="${configuration.getGenerations()}" name="generations"
                                               id="generations"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="crossoverProb">Crossover Prob.:</label>
                                    <div th:classappend="${#fields.hasErrors('crossoverProb')}? 'has-error':'crossoverProb error'">
                                        <input type="number" class="text-center" th:min="0" th:max="1" th:step="0.01"
                                               style="width: 100%"
                                               th:value="${configuration.getCrossoverProb()}" name="crossoverProb"
                                               id="crossoverProb"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="populationSize">Population size:</label>
                                    <div th:classappend="${#fields.hasErrors('populationSize')}? 'has-error':'populationSize error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 100%"
                                               th:value="${configuration.getPopulationSize()}" name="populationSize"
                                               id="populationSize"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="mutationProb">Mutation Prob.:</label>
                                    <div style="width: 100%"
                                         th:classappend="${#fields.hasErrors('mutationProb')}? 'has-error':'mutationProb error'">
                                        <input style="width: 100%" type="number" class="text-center" th:min="0"
                                               th:max="1" th:step="0.01"
                                               th:value="${configuration.getMutationProb()}" name="mutationProb"
                                               id="mutationProb"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="maxWraps">Max wraps:</label>
                                    <div th:classappend="${#fields.hasErrors('maxWraps')}? 'has-error':'maxWraps error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 100%"
                                               th:value="${configuration.getMaxWraps()}" value="3" name="maxWraps"
                                               id="maxWraps"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-4">
                                    <label for="numCodons">Num. Codons:</label>
                                    <div th:classappend="${#fields.hasErrors('numCodons')}? 'has-error':'numCodons error'">
                                        <input type="number" class="text-center" th:min="0" style="width: 100%"
                                               th:value="${configuration.getNumCodons()}" value="100" name="numCodons"
                                               id="numCodons"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-6">
                                    <label for="tournament">Tournament:</label>
                                    <div th:classappend="${#fields.hasErrors('tournament')}? 'has-error':'tournament error'">
                                        <input type="number" class="text-center" th:min="0"
                                               th:value="${configuration.getTournament()}" value="2" name="tournament"
                                               id="tournament"/>
                                    </div>
                                </div>
                                <div class="col-sm-12 col-md-6 col-lg-6">
                                    <label for="numberRuns">Number of runs:</label>
                                    <div th:classappend="${#fields.hasErrors('numberRuns')}? 'has-error':'numberRuns error'">
                                        <input type="number" class="text-center" th:min="0"
                                               th:value="${configuration.getNumberRuns()}" value="1" name="numberRuns"
                                               id="numberRuns"/>
                                    </div>
                                </div>
                            </div>

                            <div class="row form-group text-center">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <label for="tournament">Objective function:</label>
                                    <select class="form-control" name="objective" id="objective">
                                        <option value="RMSE">Root Mean Squared Error (RMSE)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <!-- END ExpPropertiesDto -->

                        <!-- Grammar file -->
                        <div class="col-sm-12 col-md-6 col-lg-6 center-block">
                            <div class="jumbotron row form-group">
                                <h4>Grammar</h4>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <label>Copy from: </label>
                                </div>
                                <div class="col-sm-7 col-md-7 col-lg-7">
                                    <select id="grammarSelect" name="grammarSelect" style="width: 100%">
                                        <option value="">Select a grammar ...</option>
                                        <option th:each="gr,iterStat : ${grammarList}" th:value="${iterStat.index}"
                                                th:text="${gr.getGrammarName() + ' - ' + gr.getGrammarDescription()}"
                                                data-toggle="tooltip"
                                                th:title="${gr.getFileText()}"/>
                                    </select>
                                </div>
                                <div class="col-sm-2 col-md-2 col-lg-2">

                                    <div class="tooltip">
                                        <button id="copyGrammarButton"
                                                type="button"
                                                onclick="copyGrammar()" onmouseout="onGrammar()">
                                            <span class="tooltiptext" id="grammarTooltip">Copy grammar</span>
                                            Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <textarea rows="8" class="form-control" name="fileText"
                                              id="fileText" th:inline="text" style="resize: none;height: 100px"
                                              th:text="${configExp.getFileText()}" placeholder="Grammar content"
                                              required></textarea>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-6 col-md-6 col-lg-6">
                                    <input id="grammarName" placeholder="Grammar name"/>
                                </div>
                                <div class="col-sm-6 col-md-6 col-lg-6">
                                    <button type="button" onclick="storeGrammar()">Store as new grammar</button>
                                </div>
                                <div class="col-sm-12 col-md-12 col-lg-12" style="margin-top: 5px">
                                    <input id="grammarDescription" placeholder="Grammar description(optional)"
                                           style="width: 100%"/>
                                </div>
                            </div>


                        </div>
                        <!-- END Grammar file -->

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!-- Training Test Validation files -->
                        <div class="col-sm-12 col-md-12 col-lg-12 center-block">
                            <div class="jumbotron row form-group">
                                <h4>Training Dataset</h4>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-12 ">
                                    <select id="datasetId" name="datasetId"
                                            onchange="updateDatasetContent()" required>
                                        <option value="">Select a dataset ...</option>
                                        <option th:each="dataset,ite : ${datasetList}" th:value="${ite.index}"
                                                th:text="${dataset.getDataTypeName() + ' - ' + dataset.getDataTypeDescription()}"
                                                th:selected="(${(experimentDataType !=null) && (experimentDataType.getId() == dataset.getId())})"/>
                                    </select>
                                    <input id="experimentDataTypeId" name="experimentDataTypeId" hidden="true"/>
                                </div>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-8">
                                    <input type="text" class="form-control" name="dataTypeName" id="dataTypeName"
                                           placeholder="Name of dataset"
                                           readonly/>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12"><input type="text" class="form-control"
                                                                                  name="dataTypeDescription"
                                                                                  id="dataTypeDescription"
                                                                                  placeholder="Description of the file"
                                                                                  readonly/>
                                </div>
                            </div>

                            <div class="row form-group text-center">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                <textarea rows="5" class="form-control" name="info"
                                          id="info" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- END Training Test Validation files -->
                        <!-- Test Test files -->
                        <div class="col-sm-12 col-md-12 col-lg-12 center-block">
                            <div class="jumbotron row form-group">
                                <h4>Test Dataset</h4>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <select id="testDatasetId" name="testDatasetId"
                                            onchange="updateTestDatasetContent()">
                                        <option value="">Select a dataset ...</option>
                                        <option th:each="dataset,ite : ${datasetList}" th:value="${ite.index}"
                                                th:text="${dataset.getDataTypeName() + ' - ' + dataset.getDataTypeDescription()}"
                                                th:selected="(${(testExperimentDataType !=null) && (testExperimentDataType.getId() == dataset.getId())})"/>
                                    </select>
                                    <input id="testExperimentDataTypeId" name="testExperimentDataTypeId" hidden="true"/>
                                </div>
                            </div>

                            <div class="row form-group center-block">
                                <div class="col-sm-12 col-md-12 col-lg-8">
                                    <input type="text" class="form-control" name="testDataTypeName"
                                           id="testDataTypeName"
                                           placeholder="Name of dataset"
                                           readonly/>
                                </div>
                            </div>
                            <div class="row form-group">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                    <input type="text" class="form-control" name="testDataTypeDescription"
                                           id="testDataTypeDescription"
                                           placeholder="Description of the file" readonly/>
                                </div>
                            </div>

                            <div class="row form-group text-center">
                                <div class="col-sm-12 col-md-12 col-lg-12">
                                <textarea rows="5" class="form-control" name="testInfo"
                                          id="testInfo" readonly></textarea>
                                </div>
                            </div>
                        </div>
                        <!-- END Test dataset-->

                        <div class="col-sm-12 col-md-12 col-lg-12">
                            <hr/>
                        </div>

                        <!--  Save Clone and Run -->
                        <div class="row text-center">
                            <div class="col-sm-12 col-md-4 col-lg-4" style="margin-bottom:2px">
                                <button type="submit" id="saveExperimentButton" name="saveExperimentButton"
                                        onclick="saveButton=true;"
                                        class="btn-primary btn-lg btn">Save experiment
                                </button>
                            </div>
                            <div class="col-sm-12 col-md-4 col-lg-4">
                                <button type="submit" id="cloneExperimentButton" name="cloneExperimentButton"
                                        class="btn-primary btn-lg btn" th:disabled="${disabledClone!=null}"
                                        onclick="cloneButton=true;">Clone
                                    experiment
                                </button>
                            </div>
                            <div class="col-sm-12 col-md-4 col-lg-4">
                                <button type="submit" id="runExperimentButton" name="runExperimentButton"
                                        class="btn-primary btn-lg btn"
                                        onclick="runButton=true;">Save and run experiment
                                </button>
                            </div>
                        </div>
                        <!-- END Save Clone and Run -->
                    </div>
                </form>

            </section>
        </div>

        <!-- END Main -->

    </div>
    <!-- RUN SECTION -->
    <div class="container" th:if="${runList!=null && not #lists.isEmpty(runList)}">
        <div id="runForms" class="panel panel-default">
            <header class="panel-heading">
                <h2>List of runs</h2>
            </header>

            <section class="panel-body">
                <table class="table table-hover" id="expTypeTable">
                    <thead>
                    <tr>
                        <th scope="col"># Run</th>
                        <th scope="col">Best solution</th>
                        <th scope="col">Current generation</th>
                        <th scope="col">Status</th>
                        <th scope="col">Creation date</th>
                        <th scope="col">Last modification date</th>
                        <th scope="col">Model</th>
                        <th scope="col"></th>
                        <th scope="col"></th>
                    </tr>
                    </thead>
                    <tbody>

                    <th:block th:each="run, iterStat : ${runList}">
                        <tr th:id="'tr' + ${iterStat.index}">
                            <td scope="row">
                                <label th:text="${iterStat.index+1}"/>
                                <label th:text="${run.getId()}"
                                       th:id="'runId'+${iterStat.index}" hidden/></td>
                            <td scope="row"><label th:name="bestIndividual"
                                                   th:id="'bestIndividual'+${iterStat.index}"
                                                   th:text="${run.getDiagramData()!=null?
                                                       run.getDiagramData().bestIndividual:'0'}"/></td>
                            <td scope="row"><label th:name="currentGeneration"
                                                   th:id="'currentGeneration'+${iterStat.index}"
                                                   th:text="${run.getDiagramData()!=null?
                                                       run.getDiagramData().currentGeneration:'0'}"/>
                            </td>
                            <td scope="row"><label th:name="status" th:id="'status'+${iterStat.index}"
                                                   th:text="${run.getStatus()}"/></td>
                            <td scope="row"><label th:name="iniDate" th:id="iniDate"
                                                   th:text="${run.getIniDateFormated()}"/></td>
                            <td scope="row"><label th:name="lastDate" th:id="lastDate+${iterStat.index}"
                                                   th:text="${run.getModificationDateFormated()}"/></td>
                            <td scope="row"><label th:name="model" th:id="model+${iterStat.index}"
                                                   th:text="${run.getModel()}"/></td>
                            <td scope="row" th:id="${'stopRunSection' + iterStat.index}"
                                th:class="${run.getStatus().toString().equals('RUNNING')?'':'hidden'}">
                                <button type="button" th:name="${run.id}"
                                        th:id="${'stopRun' + iterStat.index}"
                                        onclick="stopRun(this.id, this.name)"
                                        class="btn-default btn btn-sm"
                                        rel="tooltip"
                                        title="Stop run execution"
                                >Stop run
                                </button>
                            </td>
                            <td scope="row" th:id="'showPlot'+${iterStat.index}" class="hidden">
                                <a th:href="@{/experiment/runList(runId=${run.getId()}, showPlotExecutionButton='showPlotExecutionButton')}"
                                   target="_blank" class="btn-default btn-sm btn loadButton">Plot</a>
                            </td>
                            <td scope="row" th:id="'showDelete'+${iterStat.index}">
                                <a th:id="'showTestStats'+${iterStat.index}"
                                   th:href="@{/experiment/runList(runId=${run.getId()}, showTestStatsPlotButton='showTestStatsPlotButton')}"
                                   target="_blank" class="btn-default btn-sm btn loadButton">Stats</a>
                                <button type="button" th:name="${run.id}"
                                        th:id="${'deleteRun' + iterStat.index}"
                                        onclick="confirmDelete(this.id, this.name)"
                                        class="btn-default btn btn-sm"
                                        rel="tooltip"
                                        title="Delete run"
                                ><span
                                        class="glyphicon glyphicon-trash small"></span></button>
                            </td>
                        </tr>
                    </th:block>
                    <tr>
                        <td colspan="9">
                            <b>AVG:</b><label id="runsAVG">Waiting runs</label>
                            <b>Std.Dev:</b><label id="runsDeviation">Waiting runs</label>
                            <b>Min:</b><label id="minBestSolution">Waiting runs</label>
                            <b>Max:</b><label id="maxBestSolution">Waiting runs</label>
                        </td>
                    </tr>
                    </tbody>
                </table>

            </section>
        </div>
    </div>
    <!-- END RUN SECTION -->


    <script th:inline="javascript">

        let countModify = 0;
        let cloneButton = false;
        let datasetListInfo = [];
        let data = {};
        let indexesShow = [];
        let indexesHide = [];
        let experimentInformation;
        let runButton = false;
        let saveButton = false;
        let grammarList;
        let grammarTooltip = document.getElementById("grammarTooltip");
        let runTable = document.getElementById("expTypeTable");

        function storeGrammar() {
            let grammarName = $("#grammarName").val();
            let grammarDescription = $("#grammarDescription").val();
            let grammarContent = $("#fileText").val();
            if (grammarContent == "" || grammarName == "") {
                alert("Grammar name and content cannot be empty");
                return;
            }
            $.ajax({
                url: encodeURI("/grammar/ajaxSaveGrammar"),
                data: {
                    'grammarName': grammarName,
                    'grammarDescription': grammarDescription,
                    'grammarContent': grammarContent,
                },
                async: true,
                type: "POST",
                success: function () {
                    alert("New grammar saved");
                },
                error: function () {
                    alert("Fail on save new grammar");
                }
            });
        }

        $(document).ready(function () {
            /*<![CDATA[*/
            experimentInformation = [[${configuration}]];
            grammarList = [[${grammarList}]];
            /*]]>*/

            saveDatasetInfo();
            updateDatasetContent()
            updateTestDatasetContent()

            $('[name="status"]').each(function (index) {
                if (($(this).text() == "FINISHED") || ($(this).text() == "STOPPED") || ($(this).text() == "FAILED")) {
                    indexesShow[index] = index;
                }
                if (($(this).text() == "RUNNING") || ($(this).text() == "INITIALIZING") || ($(this).text() == "WAITING")) {
                    indexesHide[index] = index;
                    showRunStatus("runExperimentButton" + index);
                }
            });

            indexesShow.forEach(function (element, index) {
                $("#runExperimentButton" + indexesShow[index]).removeClass("hidden");
                $("#showDelete" + indexesShow[index]).removeClass("hidden");
                $("#showPlot" + indexesShow[index]).removeClass("hidden");
            });

            indexesHide.forEach(function (element, index) {
                $("#showDelete" + indexesHide[index]).addClass("hidden");
                $("#runExperimentButton" + indexesShow[index]).addClass("hidden");
            });

            calculateRunsStats(runTable, '#runsAVG', '#runsDeviation', '#maxBestSolution', '#minBestSolution');
            //all input check
            $("input").change(function () {
                if (this.id != "grammarName" && this.id != "grammarDescription") {
                    countModify = this.value == experimentInformation[this.id] ? countModify - 1 : countModify + 1;
                    checkShowAlert(this.id)
                }
            })
            //grammar check
            $("#fileText").change(function () {
                countModify = experimentInformation[this.id].split(/[\s]+/).join() === this.value.split(/[\s]+/).join() ?
                    countModify - 1 : countModify + 1;
                checkShowAlert(this.id)
            })
            //dataset check
            $("#datasetId").change(function () {
                countModify = experimentInformation['defaultExpDataTypeId'] == $('#experimentDataTypeId').val() ?
                    countModify - 1 : countModify + 1;
                checkShowAlert(this.id);
            })
        });

        function copyGrammar() {
            if (grammarList[$("#grammarSelect").val()]) {
                $("#fileText").val(grammarList[$("#grammarSelect").val()].fileText);
                grammarTooltip.innerHTML = "Copied";
            }
        }

        function onGrammar() {
            grammarTooltip.innerHTML = "Copy grammar";
        }

        function updateDatasetContent() {
            if ($('#datasetId').val() != "") {
                let i = parseInt($('#datasetId').val());
                $('#dataTypeName').val(datasetListInfo[i].dataTypeName);
                $('#dataTypeDescription').val(datasetListInfo[i].dataTypeDescription);
                $('#info').val(datasetListInfo[i].info);
                $('#experimentDataTypeId').val(datasetListInfo[i].idDataset);
            } else {
                $('#dataTypeName').val("");
                $('#dataTypeDescription').val("");
                $('#info').val("");
            }
        }

        function updateTestDatasetContent() {
            if ($('#testDatasetId').val() != "") {
                let i = parseInt($('#testDatasetId').val());
                $('#testDataTypeName').val(datasetListInfo[i].dataTypeName);
                $('#testDataTypeDescription').val(datasetListInfo[i].dataTypeDescription);
                $('#testInfo').val(datasetListInfo[i].info);
                $('#testExperimentDataTypeId').val(datasetListInfo[i].idDataset);
            } else {
                $('#testDataTypeName').val("");
                $('#testDataTypeDescription').val("");
                $('#testInfo').val("");
                $('#testExperimentDataTypeId').val("");
            }
        }

        function saveDatasetInfo() {
            /*<![CDATA[*/
            /*[# th:each="dataset : ${datasetList}"]*/
            data = {};
            data.idDataset =/*[[${dataset.getId()}]]*/;
            data.dataTypeName =/*[[${dataset.getDataTypeName()}]]*/;
            data.dataTypeDescription =/*[[${dataset.getDataTypeDescription()}]]*/;
            data.info =/*[[${dataset.getInfo()}]]*/;
            datasetListInfo.push(data);
            /*[/]*/
            /*]]>*/
        }

        function checkRunStatus(runId, status, bestIndividual, currentGeneration, model, iterStat) {
            $.ajax({
                url: encodeURI("/rest/runStatus/"),
                data: {
                    'runId': runId.text(),
                    'status': $(status).text()
                },
                cache: false,
                async: true,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    let statusStr = data['status'];
                    let bestIndividualStr = data['bestIndividual'];
                    let currentGenerationStr = data['currentGeneration'];
                    let lastDate = data['modificationDateFormated'];
                    let modelStr = data['model'] === "" ? "Waiting for finish" : data['model'];

                    $(status).text(statusStr);
                    $(bestIndividual).text(bestIndividualStr);
                    $(currentGeneration).text(currentGenerationStr);
                    $(model).text(modelStr);
                    $('#lastDate' + iterStat).text(lastDate);
                },
                complete: function () {
                    let runId = $("#runId" + iterStat);
                    let status = "#status" + iterStat;
                    let currentGeneration = "#currentGeneration" + iterStat;
                    let bestIndividual = "#bestIndividual" + iterStat;

                    if ($(status).text() === "RUNNING") {
                        $("#showPlot" + iterStat).removeClass("hidden");
                        $("#stopRunSection" + iterStat).removeClass("hidden");
                    }

                    if (($(status).text() != "FINISHED") && ($(status).text() != "STOPPED") && ($(status).text() != "FAILED")) {
                        $("#runExperimentButton" + iterStat).addClass("hidden");
                        $("#showDelete" + iterStat).addClass("hidden");
                        setTimeout(function () {
                            checkRunStatus(runId, status, bestIndividual, currentGeneration, model, iterStat);
                        }, 2000);
                    }

                    if (($(status).text() == "FINISHED") || ($(status).text() == "STOPPED") || ($(status).text() == "FAILED")) {
                        $("#showDelete" + iterStat).removeClass("hidden");
                        $("#stopRunSection" + iterStat).addClass("hidden");
                        $("#runExperimentButton" + iterStat).removeClass("hidden");
                        if ($(model).text() === "Waiting for finish") {
                            setTimeout(function () {
                                checkRunStatus(runId, status, bestIndividual, currentGeneration, model, iterStat);
                            }, 2000);
                        }
                        calculateRunsStats(runTable, '#runsAVG', '#runsDeviation', '#maxBestSolution', '#minBestSolution');
                    }
                }
            });
        };

        function showRunStatus(iterStat) {
            let cleanIterStat = iterStat.substring("runExperimentButton".length, iterStat.length);

            let runId = $("#runId" + cleanIterStat);
            let status = "#status" + cleanIterStat;
            let currentGeneration = "#currentGeneration" + cleanIterStat;
            let bestIndividual = "#bestIndividual" + cleanIterStat;
            let model = "#model" + cleanIterStat;


            setTimeout(function () {
                checkRunStatus(runId, status, bestIndividual, currentGeneration, model, cleanIterStat)
            }, 2000);
        }

        function confirmDelete(iterStat, runId) {
            let result = confirm("Are you sure to delete this run ?");
            if (result)
                deleteRow(iterStat, runId);
        }

        function stopRun(iterStat, runId) {
            if (confirm("Are you sure to stop this run ?")) {
                let cleanIterStat = iterStat.substring("stopRun".length, iterStat.length);

                $.ajax({
                    url: encodeURI("/experiment/stopRunAjax"),
                    data: {
                        'runIdStop': runId,
                    },
                    cache: false,
                    async: true,
                    type: "POST",
                    dataType: "json",
                    success: function () {
                        $("#stopRunSection" + cleanIterStat).addClass("hidden");
                    }
                });
            }
        }

        function deleteRow(iterStat, runId) {
            let cleanIterStat = iterStat.substring("deleteRun".length, iterStat.length);

            $.ajax({
                url: encodeURI("/experiment/expRepoSelected"),
                data: {
                    'runId': runId,
                    'deleteRun': 'deleteRun'
                },
                cache: false,
                async: true,
                type: "POST",
                dataType: "json",
                success: function (data) {
                    $("#tr" + cleanIterStat).remove();
                    $("#trAux" + cleanIterStat).remove();
                }
            });
        }

        function checkDeletePreviousRun() {
            if (document.getElementById("runForms") && !cloneButton && !(saveButton && checkExperimentInformationEqual())) {
                return confirm('Do you really want to run it? This will delete the previous runs...');
            } else {
                return true;
            }
        }

        function checkExperimentInformationEqual() {
            let experimentName = $('#experimentName').val();
            let experimentDescription = $('#experimentDescription').val();
            let generations = $('#generations').val();
            let crossoverProb = $('#crossoverProb').val();
            let populationSize = $('#populationSize').val();
            let mutationProb = $('#mutationProb').val();
            let maxWraps = $('#maxWraps').val();
            let numCodons = $('#numCodons').val();
            let tournament = $('#tournament').val();
            let numberRuns = $('#numberRuns').val();
            let objective = $('#objective').val();
            let grammar = $('#fileText').val();
            let datasetId = $('#experimentDataTypeId').val();
            experimentInformation['defaultExpDataTypeId'] =
                experimentInformation['defaultExpDataTypeId'] == null ? "" : experimentInformation['defaultExpDataTypeId'];

            return (experimentInformation['experimentName'] === experimentName &&
                experimentInformation['experimentDescription'] === experimentDescription &&
                experimentInformation['generations'] == generations &&
                experimentInformation['crossoverProb'] == crossoverProb &&
                experimentInformation['populationSize'] == populationSize &&
                experimentInformation['mutationProb'] == mutationProb &&
                experimentInformation['maxWraps'] == maxWraps &&
                experimentInformation['numCodons'] == numCodons &&
                experimentInformation['tournament'] == tournament &&
                experimentInformation['numberRuns'] == numberRuns &&
                experimentInformation['objective'] === objective &&
                grammar.split(/[\s]+/).join() == experimentInformation['fileText'].split(/[\s]+/).join() &&
                experimentInformation['defaultExpDataTypeId'] == datasetId);
        }

        window.onbeforeunload = function (e) {
            if ((document.getElementById("cloneMessage") && !runButton && !saveButton)
                || (!checkExperimentInformationEqual() && !runButton && !saveButton)) {
                return 'Sure?';
            }
        }

        function checkShowAlert(identifier) {
            console.log(1)
            if (countModify > 0) {
                $("#messageModify").removeClass("hidden");
                $("#" + identifier).css("border-color", "#c09853")
            } else {
                $("#messageModify").addClass("hidden");
                $("#" + identifier).css("border-color", "")
            }
            $("#messageModifyText").text("The experiment has been modified, " + countModify + " marked.")
        }

    </script>
</div>
</body>
</html>